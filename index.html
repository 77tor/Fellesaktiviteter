<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skoleplan 2025/2026 - Live</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
        .info-box { background: #e8f4fd; padding: 12px; border-radius: 5px; margin-bottom: 20px; font-size: 0.85em; border-left: 5px solid #3498db; text-align: center; }
        .controls { 
            margin-bottom: 25px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 30px; 
            background: #fdfdfd; 
            padding: 20px; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }
        select, input { padding: 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; width: 100%; }
        .status-msg { text-align: center; padding: 40px; font-style: italic; color: #3498db; }
        .error-msg { color: #721c24; background: #f8d7da; padding: 20px; border-radius: 5px; margin: 20px 0; border: 1px solid #f5c6cb; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; display: none; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #edf2f7; font-size: 14px; }
        th { background-color: #34495e; color: white; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f1f8ff; }
        .btn-reset { grid-column: 1 / -1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h1>Fellesaktiviteter – 2025/2026</h1>
    <div class="info-box">
        Heståsen (1.-3.trinn) | Brattbakken (4.-7.trinn)
    </div>

    <div class="controls">
        <div class="filter-group">
            <label>Søk</label>
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Søk tekst...">
        </div>
        <div class="filter-group">
            <label>Deltakelse</label>
            <select id="deltakerFilter" onchange="filterTable()">
                <option value="">Vis alle</option>
                <option value="1.">1. trinn</option>
                <option value="2.">2. trinn</option>
                <option value="3.">3. trinn</option>
                <option value="4.">4. trinn</option>
                <option value="5.">5. trinn</option>
                <option value="6.">6. trinn</option>
                <option value="7.">7. trinn</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Ansvar</label>
            <select id="ansvarFilter" onchange="filterTable()">
                <option value="">Vis alle</option>
                <optgroup label="Klassetrinn">
                    <option value="1.">1. trinn</option>
                    <option value="2.">2. trinn</option>
                    <option value="3.">3. trinn</option>
                    <option value="4.">4. trinn</option>
                    <option value="5.">5. trinn</option>
                    <option value="6.">6. trinn</option>
                    <option value="7.">7. trinn</option>
                </optgroup>
                <optgroup label="Eksklusive">
                    <option value="FAU">FAU</option>
                    <option value="KIRKA">Kirka</option>
                    <option value="ELEVRÅDET">Elevrådet</option>
                </optgroup>
            </select>
        </div>
        <button class="btn-reset" onclick="resetFilters()">Nullstill filtre</button>
    </div>

    <div id="errorBox" class="error-msg"></div>
    <div id="loader" class="status-msg">Henter data fra Google...</div>
    
    <table id="aktivitetsTabell">
        <thead>
            <tr>
                <th>Måned</th>
                <th>Aktivitet</th>
                <th>Dato / Uke</th>
                <th>Deltakere</th>
                <th>Ansvar</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // Bruker din spesifikke publiserings-URL
    const csvUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://docs.google.com/spreadsheets/d/e/2PACX-1vSi6gI-wibRP6kVxmBkCP7LdHxOBBnmSx7-uZcAAKLFEw_YXl7f7HWeJjlE-QdoVw/pub?output=csv');

    async function fetchData() {
        const errorBox = document.getElementById('errorBox');
        const loader = document.getElementById('loader');
        
        try {
            const response = await fetch(csvUrl);
            if (!response.ok) throw new Error("Status: " + response.status + ". Kunne ikke hente filen.");
            
            const data = await response.text();
            console.log(data); // <--- LEGG TIL DENNE
            
            // Sjekk om dataene ser ut som CSV
            if (data.includes("<!DOCTYPE") || data.length < 50) {
                throw new Error("Mottok ikke gyldig tabell-data. Sjekk at du har valgt 'Publiser på nettet' -> 'CSV'.");
            }

            renderTable(data);
        } catch (err) {
            loader.style.display = 'none';
            errorBox.style.display = 'block';
            errorBox.innerHTML = "<strong>Tilkoblingsfeil:</strong> " + err.message + 
                "<br><br>Sørg for at arket er publisert offentlig i Google Sheets via <em>Fil -> Del -> Publiser på nettet (CSV)</em>.";
        }
    }

    function renderTable(csvText) {
        const tableBody = document.getElementById('tableBody');
        const lines = csvText.split(/\r?\n/);
        
        lines.forEach((line, index) => {
            // Hopper over overskriftsraden og tomme linjer
            if (index === 0 || line.trim() === "") return;

            // Splitter kolonner og håndterer sitattegn (CSV-standard)
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (parts.length < 4) return;

            const tr = document.createElement('tr');
            // Vi tar de 5 første kolonnene
            for (let i = 0; i < 5; i++) {
                const td = document.createElement('td');
                let val = parts[i] ? parts[i].replace(/^"|"$/g, '').trim() : "";
                td.textContent = val;
                tr.appendChild(td);
            }
            tableBody.appendChild(tr);
        });

        document.getElementById('loader').style.display = 'none';
        document.getElementById('aktivitetsTabell').style.display = 'table';
    }

    function filterTable() {
        const search = document.getElementById("searchInput").value.toUpperCase();
        const dTrinn = document.getElementById("deltakerFilter").value;
        const aVal = document.getElementById("ansvarFilter").value;
        const rows = document.querySelectorAll("#tableBody tr");

        rows.forEach(row => {
            const cells = row.getElementsByTagName("td");
            const dText = cells[3].textContent.toUpperCase();
            const aText = cells[4].textContent.toUpperCase();
            const fullText = row.textContent.toUpperCase();

            // Deltaker-logikk
            let mD = (dTrinn === "") || dText.includes(dTrinn) || dText.includes("ALLE TRINN") ||
                     (["1.", "2.", "3."].includes(dTrinn) && dText.includes("HESTÅSEN")) ||
                     (["4.", "5.", "6.", "7."].includes(dTrinn) && dText.includes("BRATTBAKKEN"));

            // Ansvar-logikk
            let mA = (aVal === "");
            if (aVal !== "") {
                if (["FAU", "KIRKA", "ELEVRÅDET"].includes(aVal)) {
                    mA = aText.includes(aVal);
                } else {
                    const erH = ["1.", "2.", "3."].includes(aVal);
                    const erB = ["4.", "5.", "6.", "7."].includes(aVal);
                    mA = aText.includes(aVal) || aText.includes("ALLE TRINN") ||
                         (erH && aText.includes("HESTÅSEN")) ||
                         (erB && aText.includes("BRATTBAKKEN"));
                }
            }
            row.style.display = (mD && mA && fullText.includes(search)) ? "" : "none";
        });
    }

    function resetFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("deltakerFilter").value = "";
        document.getElementById("ansvarFilter").value = "";
        filterTable();
    }

    window.onload = fetchData;
</script>

</body>
</html>